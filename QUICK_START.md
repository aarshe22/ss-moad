# MOAD Quick Start Guide

## Prerequisites

1. Docker and Docker Compose installed
2. Access to `/data/moad/logs` (NFS mount with log files)
3. MySQL database accessible for metrics
4. Ports 3000, 3100, 9090, 9104 available
5. **Required Ubuntu/Debian packages:**
   - `dialog` - For MOAD Manager UI (will prompt to install if missing)
   - `jq` - For JSON processing in backup/restore (will prompt to install if missing)
   - `coreutils` - For base64, numfmt, and other utilities (usually pre-installed)

**Install required packages:**
```bash
sudo apt-get update
sudo apt-get install -y dialog jq
```

## 1. Clone Repository

```bash
git clone <repository-url>
cd ss-moad
```

## 2. Configure Environment

**Recommended: Use the MOAD Manager**

```bash
./moad-manager.sh
# Select "1. Environment: Generate .env File" from the menu
```

The MOAD Manager will:
- Show a status bar with container health at the top
- Prompt for MySQL configuration (host, user, password)
- Pre-load existing values if `.env` already exists (press Enter to keep)
- Generate secure random 14-character passwords for Grafana admin and MySQL Grafana user
- Create the `.env` file with all required variables
- Display generated passwords for easy copy/paste

**Alternative: Create manually**

```bash
# Create .env file manually
cat > .env << EOF
GRAFANA_ADMIN_PASSWORD=your_secure_password_here
MYSQL_HOST=192.168.1.100
MYSQL_MOAD_RO_USER=moad_ro
MYSQL_MOAD_RO_PASSWORD=your_moad_ro_password
MYSQL_GRAFANA_PASSWORD=your_grafana_readonly_password
EOF
```

**Note:** 
- `MYSQL_HOST` should be the IP address or hostname of your MySQL server (IP recommended for Docker networks)
- `MYSQL_MOAD_RO_USER` is the MySQL username (default: `moad_ro`)
- `MYSQL_MOAD_RO_PASSWORD` is the password for the MySQL user (read-only access to schoolsoft and permissionMan databases)
- Passwords are randomly generated by MOAD Manager for security
- If `.env` already exists, MOAD Manager will pre-load values for easy updates

## 3. Verify Log Paths

Ensure log files exist:
```bash
ls -la /data/moad/logs/app1/usr/share/apache-tomcat-8.5.94/logs/catalina.out
ls -la /data/moad/logs/app2/usr/share/apache-tomcat-8.5.94/logs/catalina.out
```

## 4. Start Services

**Option 1: Use MOAD Manager (Recommended)**
```bash
./moad-manager.sh
# Select "4. Docker: Start All Containers" (if containers exist)
# OR "5. Docker: Create & Start" (if starting fresh or need rebuild)
```

The MOAD Manager provides:
- **Status Bar**: Real-time container health at the top
- **Progress Bars**: Visual feedback for all operations
- **Color-Coded Menu**: Easy navigation by function
- **Smart Operations**: Automatically detects if containers need to be created

**Option 2: Use docker compose directly**
```bash
docker compose up -d
```

## 5. Verify Services

```bash
docker compose ps
# Should show all services as "Up"
```

## 6. Access Services

You can view service URLs and access information in MOAD Manager:
```bash
./moad-manager.sh
# Select "13. Services: Show Service URLs"
```

Or access directly:
- **Grafana**: http://dev1.schoolsoft.net:3000
  - Username: `admin`
  - Password: (from `.env` file - displayed when running MOAD Manager)
- **Prometheus**: http://dev1.schoolsoft.net:9090
- **Loki**: http://dev1.schoolsoft.net:3100

## 7. Verify Log Processing

```bash
# Check Vector is processing logs
docker logs moad-vector | tail -20

# Check structured logs are being created
ls -la data/vector/structured/

# Query Loki for events
curl -G "http://localhost:3100/loki/api/v1/query" \
  --data-urlencode 'query={app="CM"}' \
  --data-urlencode 'limit=5'
```

## 8. Check Join Compatibility

```bash
# View structured logs with join hints
cat data/vector/structured/*.jsonl 2>/dev/null | jq 'select(.mysql_joins != null) | {event_type, mysql_joins, mysql_join_school_id}' | head -10
```

## Troubleshooting

### Using MOAD Manager for Troubleshooting

The MOAD Manager provides built-in troubleshooting tools:
```bash
./moad-manager.sh
# Useful options:
# - "3. Docker: View Container Status" - See all container states
# - "9. Docker: View Container Logs" - View logs for specific containers
# - "10. Docker: View Recent Errors" - Scan all containers for errors
# - "14. Services: Check Service Health" - Test all service endpoints
# - "15. Services: Test MySQL Connectivity" - Verify MySQL connection
```

### Services Not Starting
```bash
# Use MOAD Manager
./moad-manager.sh
# Select "10. Docker: View Recent Errors"

# Or use docker compose directly
docker compose logs
docker compose restart
```

### Vector Not Processing Logs
1. Verify log file paths exist and are readable
2. Check Vector logs: `docker logs moad-vector`
3. Verify file permissions on `/data/moad/logs`
4. Check Vector entrypoint validation: Entrypoint script validates config and log paths before starting

### No Data in Grafana
1. Verify Loki is receiving logs: `docker logs moad-loki`
2. Check datasources are configured in Grafana UI
3. Verify queries return data in Loki: http://localhost:3100/ready

### MySQL Metrics Not Appearing
1. Verify MySQL exporter can connect: `docker logs moad-mysqld-exporter`
2. Check Prometheus targets: http://localhost:9090/targets
3. Verify MySQL host is accessible from container network
4. Check entrypoint script output: Should show "Created .my.cnf file at: /tmp/.my.cnf"
5. Verify environment variables are set: `docker exec moad-mysqld-exporter env | grep MYSQL`

## Backup and Restore

MOAD Manager includes full backup and restore functionality for migrating to new servers:

### Create Backup
```bash
./moad-manager.sh
# Select "20. Backup: Backup MOAD Configuration"
```

This creates a JSON backup file containing:
- `.env` file (all passwords and configuration)
- All configuration files (docker-compose.yml, vector.yml, prometheus.yml, loki-config.yml)
- Grafana provisioning and dashboard files
- Backup metadata (version, timestamp, hostname)

**⚠️ Warning**: Backup files contain sensitive information (passwords). Store securely!

### Restore on New Server
```bash
# 1. Clone repository
git clone <repository-url>
cd ss-moad

# 2. Run MOAD Manager
./moad-manager.sh

# 3. Select "21. Backup: Restore MOAD Configuration"
# 4. Select your backup file
# 5. Review backup info and confirm restore

# 6. Start services
# Select "4. Docker: Start All Containers" or "5. Docker: Create & Start"
```

The restore process will:
- Validate backup file structure
- Show backup metadata (version, timestamp, hostname)
- Restore all configuration files to original paths
- Create directories as needed
- Provide restore summary

## Next Steps

1. Review dashboards in Grafana
2. Create additional dashboards for your use cases
3. Set up alerts for critical events
4. Validate join compatibility (see `docs/VALIDATION_GUIDE.md`)
5. Create regular backups using MOAD Manager

For detailed information, see:
- `README.md` - Project overview
- `DEPLOYMENT_CHECKLIST.md` - Comprehensive deployment guide
- `docs/` - Technical documentation

